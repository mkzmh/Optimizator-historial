import requests
import json
from urllib.parse import quote
from math import radians, sin, cos, sqrt, atan2
from itertools import combinations
import time

# =============================================================================
# 1. CONFIGURACIÓN BASE Y COORDENADAS
# =============================================================================

API_KEY = "2ce810e0-dc57-4aa4-8099-bf0e33ec48e9"
URL_ROUTE = f"https://graphhopper.com/api/1/route?key={API_KEY}"
HEADERS = {'Content-Type': 'application/json'}
COORDENADAS_ORIGEN = [-64.245138888888889, -23.260327777777778]
VEHICLES = {
"AF820AB": {"name": "Camión 1 (Ruta A)"},
"AE898TW": {"name": "Camión 2 (Ruta B)"},
}

# Diccionario de coordenadas (Completo)
COORDENADAS_LOTES = {
"A01_1": [-64.254233333333332, -23.255027777777777], "A01_2": [-64.26275833333334, -23.24804166666667], "A05": [-64.25640277777778, -23.247030555555558],
"A05_2": [-64.254025, -23.249480555555557], "A06_1": [-64.246711111111111, -23.245766666666668], "A06_2": [-64.246180555555554, -23.247272222222222],
"A07_1": [-64.24048611111111, -23.244858333333333], "A07_2": [-64.24014722222222, -23.246097222222222], "A08_1": [-64.212313888888886, -23.247027777777777],
"A08_2": [-64.20845833333334, -23.243086111111111], "A08_3": [-64.203083333333339, -23.239622222222224], "A09_1": [-64.229127777777776, -23.249513888888888],
"A09_2": [-64.231513888888884, -23.247052777777778], "A09_3": [-64.231916666666663, -23.243977777777779], "A09_4": [-64.233241666666672, -23.240794444444447],
"A09_5": [-64.23063333333333, -23.239572222222222], "A10": [-64.211733333333342, -23.258305555555555], "A11": [-64.218877777777777, -23.262127777777778],
"A12": [-64.212088888888886, -23.26871388888889], "A13": [-64.231938888888891, -23.259661111111111], "A14": [-64.22719722222223, -23.265916666666666],
"A17_1": [-64.238605555555552, -23.263994444444446], "A17_2": [-64.241294444444449, -23.259813888888889], "A17_3": [-64.243452777777776, -23.26175],
"A18_1": [-64.232875, -23.271013888888888], "A18_2": [-64.228877777777782, -23.2743], "A21_1": [-64.223297222222229, -23.272861111111109],
"A21_2": [-64.218630555555563, -23.27889722222222], "A22": [-64.217616666666672, -23.272988888888889], "A26_1": [-64.22711944444444, -23.27965],
"A26_2": [-64.221427777777777, -23.279033333333331], "A26_3": [-64.218847222222223, -23.283241666666665], "A26_4": [-64.222840555555564, -23.288533333333334],
"A69_1": [-64.281747222222222, -23.27563056], "A69_2": [-64.283708333333337, -23.271686111111109], "A69_3": [-64.277205555555554, -23.276138888888887],
"A41": [-64.402366666666666, -23.251111111111111], "A45_1": [-64.264541666666673, -23.25691388888889], "A45_2": [-64.2589611111111, -23.259097222222223],
"A45_3": [-64.2605, -23.26198611111111], "A45_4": [-64.255836111111108, -23.261841666666665], "A49_1": [-64.252302777777771, -23.263213888888888],
"A49_2": [-64.253686111111108, -23.265316666666667], "A49_3": [-64.255547222222219, -23.266352777777779], "A50": [-64.247672222222221, -23.270552777777777],
"A51": [-64.241583333333338, -23.276441666666667], "A29_1": [-64.238097222222223, -23.282166666666665], "A29_2": [-64.23720833333332, -23.284733333333335],
"A30": [-64.229411111111119, -23.290780555555557], "A33_1": [-64.243513888888884, -23.288263888888892], "A33_2": [-64.237407777777776, -23.290283333333335],
"A55": [-64.249113888888886, -23.282652777777777], "A54": [-64.256119444444451, -23.275861111111109], "A53": [-64.260413888888891, -23.270105555555556],
"A61": [-64.264930555555551, -23.265855555555557], "A62_1": [-64.270480555555551, -23.259369444444445], "A62_2": [-64.270394444444449, -23.254227777777778],
"A65": [-64.273291666666665, -23.268458333333331], "A66": [-64.2765611111111, -23.272052777777777], "A74_1": [-64.272405555555551, -23.281619444444445],
"A74_2":[-64.269047222222227, -23.280011111111111], "A73_1": [-64.263908333333333, -23.278022222222223], "A73_2": [-64.258861111111116, -23.283611111111114],
"B05": [-64.27883611, -23.25469167], "B06": [-64.28556111, -23.25046944], "B07_1": [-64.28989167, -23.244875], "B07_2": [-64.29418611, -23.24563333],
"B10": [-64.29096667, -23.25751944], "B09_1": [-64.28218611, -23.25921944], "B09_2": [-64.28712778, -23.26185833], "B09_3": [-64.2837, -23.26375833],
"B22_1": [-64.29549167, -23.26170556], "B22_2": [-64.29766389, -23.26524167], "B21": [-64.28976667, -23.26921111], "B25_1": [-64.28971111, -23.27639444],
"B25_2": [-64.29582778, -23.27570278], "B26": [-64.30286389, -23.27183611], "B29_1": [-64.31462778, -23.27323333], "B29_2": [-64.30697778, -23.27561944],
"B02": [-64.29092778, -23.22938056], "B03_1": [-64.29450278, -23.21945833], "B03_2": [-64.29607222, -23.21335], "B03_3": [-64.29896667, -23.21808056],
"B01": [-64.28866389, -23.23769722], "B11_1": [-64.29810556, -23.25266944], "B11_2": [-64.29301111, -23.25046944], "B23_1": [-64.30458056, -23.262025],
"B23_2": [-64.30686389, -23.25935833], "B23_3": [-64.30243056, -23.25775278], "B27": [-64.30988333, -23.26800833], "B43": [-64.29583056, -23.22983056],
"B42": [-64.30395278, -23.22773056], "B45_1": [-64.30093333, -23.24017778], "B45_2": [-64.29969722, -23.23788056], "B45_3": [-64.29517222, -23.23766944],
"B46_1": [-64.30943056, -23.23384444], "B46_2": [-64.30601944, -23.23236944], "B51_1": [-64.31641944, -23.24205], "B51_2": [-64.31470556, -23.23896389],
"B51_3": [-64.31318889, -23.23779722], "B50_1": [-64.31118889, -23.24491111], "B50_2": [-64.30850833, -23.24146111], "B50_3": [-64.30610833, -23.24105278],
"B49_1": [-64.30613889, -23.251], "B49_2": [-64.30483333, -23.24885278], "B49_3": [-64.30315556, -23.24665556], "B49_4": [-64.30136389, -23.24470556],
"B62": [-64.32173056, -23.25151944], "B61": [-64.31205, -23.25574444], "B66": [-64.32609444, -23.25722222], "B65_1": [-64.31492222, -23.26458889],
"B65_2": [-64.31813333, -23.261925], "B70_1": [-64.33281944, -23.26483056], "B70_2": [-64.33033889, -23.26101667], "B69": [-64.32278333, -23.26843889],
"B73": [-64.337975, -23.26780556],"C95": [-64.27967222, -23.16982222],"C96A": [-64.28108889, -23.18125],"C96B":[-64.28434444, -23.19291944],
"C94_1": [-64.28434444, -23.18400556],"C94_2": [-64.29844444, -23.17875556],"C93_1": [-64.30213333, -23.18875],"C93_2": [-64.30673333, -23.17960278],
"C92_1": [-64.31294444, -23.161675],"C92_2": [-64.31273056, -23.17389167],"C91": [-64.31425556, -23.16244444],"C90": [-64.31717222, -23.16824444],
"C92": [-64.326025, -23.16192222],"C41": [-64.32256667, -23.19310556],"C46": [-64.32658889, -23.17461944],
"C45_1": [-64.31968889, -23.17896111],"C45_2": [-64.31573889, -23.17761944],"C45_3": [-64.32166667, -23.18278056],"C08": [-64.31147778, -23.19530556],
"C17": [-64.31416667, -23.19593611],"C86_1": [-64.30626944, -23.20488056],"C86_2": [-64.304925, -23.20169444],"C86_3": [-64.30163056, -23.19883333],
"C85_1": [-64.30325, -23.20513889],"C85_2": [-64.3006, -23.20516389],"C85_3": [-64.29814722, -23.20730556],"C01_1": [-64.31086389, -23.21022222],
"C01_2": [-64.30634722, -23.214075],"C25": [-64.31645278, -23.201725],"C26_1": [-64.32287222, -23.19051667],"C26_2": [-64.32486111, -23.20288611],
"C53": [-64.33030556, -23.19233611],"C54_1": [-64.33539167, -23.19435],"C54_2": [-64.35505556, -23.18517222],"C54_3": [-64.34508889, -23.18558333],
"C62": [-64.34688333, -23.197625],"C61_1": [-64.33671111, -23.20292222],"C61_2": [-64.34221944, -23.20017778],"C36": [-64.35548056, -23.20785178],
"C29": [-64.32297222, -23.21308333],"C06": [-64.31031667, -23.21638056],"C05": [-64.31031667, -23.21283333],"C09": [-64.31626111, -23.22830278],
"C15": [-64.32188056, -23.23407222],"C33": [-64.32833611, -23.21985278],"C34": [-64.33465556, -23.2316],"C65": [-64.34196944, -23.21102222],
"C71": [-64.35738889, -23.21276111],"C67": [-64.36113611, -23.21505833],"C70": [-64.35009444, -23.21868611],"C38": [-64.34041111, -23.22358333],
"C37_1": [-64.33332778, -23.22625],"C37_2": [-64.33656111, -23.230875],"C14": [-64.35105278, -23.23276111],"C66_1": [-64.35322222, -23.20456667],
"C66_2": [-64.34660278, -23.20635278],"C21": [-64.31733056, -23.19439167],"C49": [-64.32541389, -23.18858589],"C50_1": [-64.33231389, -23.18301389],
"C51": [-64.33939444, -23.18397222],"C13": [-64.32144444, -23.23582222],"D01": [-64.3280889, -23.2434056],"D02": [-64.3358889, -23.2389139],
"D21": [-64.343425, -23.2347417],"D22": [-64.3499556, -23.2298556],"D41": [-64.3574222, -23.2257],"D42": [-64.3637361, -23.2207222],
"D46": [-64.3697472, -23.2289028],"D45_1": [-64.3625389, -23.2312583],"D45_2": [-64.3651222, -23.2351139],"D26": [-64.3556833, -23.2369722],
"D25": [-64.3486, -23.2419333],"D06": [-64.3420889, -23.2462917],"D05": [-64.3344639, -23.2509306],"D09": [-64.3398583, -23.2583694],
"D10": [-64.347825, -23.2534778],"D29": [-64.3546306, -23.2494611],"D30": [-64.3612056, -23.2441889],"D49": [-64.3687194, -23.2401028],
"D50": [-64.3756833, -23.2359278],"D54": [-64.3812139, -23.2427556],"D53": [-64.3750417, -23.2479444],"D34": [-64.3672556, -23.2525417],
"D33": [-64.3599333, -23.2567444],"D14": [-64.353425, -23.260925],"D13": [-64.3454167, -23.2654944],"D64": [-64.3860944, -23.2496278],
"D63": [-64.3800722, -23.2547556],"D62": [-64.3728222, -23.2585389],"D61": [-64.3666056, -23.2623722],"D67": [-64.391925, -23.2572139],
"D66": [-64.3853306, -23.2624583],"D65": [-64.3777806, -23.2656889],"D69": [-64.396425, -23.2649833],"K01": [-64.2607, -23.2992278],
"K21": [-64.2633033, -23.3040306],"K02": [-64.2693667, -23.2973389],"K22": [-64.2703806, -23.3054722],"K03": [-64.2777722, -23.2943694],
"K23": [-64.2789611, -23.3043861],"K43": [-64.2839722, -23.310575],"K04": [-64.2862389, -23.2930361],"K24": [-64.2872778, -23.3033222],
"K44": [-64.2892972, -23.3126944],"K64": [-64.289575, -23.3181944],"K05": [-64.29475, -23.2932889],"K25": [-64.2962861, -23.30265],
"K45_1": [-64.3059278, -23.30845],"K45_2": [-64.3051667, -23.3093306],"K46_1": [-64.3051667, -23.3127528],"K46_2": [-64.3159583, -23.3132306],
"K65": [-64.2993861, -23.3176972],"K06": [-64.3040694, -23.2944722],"K26": [-64.304025, -23.3009833],"K66": [-64.307025, -23.3188167],"K07": [-64.3123333, -23.2925972],
"K27": [-64.3131861, -23.3002833],"K47": [-64.3145, -23.3089278],"K67": [-64.3155417, -23.3183417],"K08_1": [-64.3180806, -23.2872306],
"K08_2": [-64.32015, -23.2912056],"K28_1": [-64.3212333, -23.295425],"K28_2": [-64.3216611, -23.2991722],"K48": [-64.32382167, -23.3080806],
"K68": [-64.3235194, -23.3171139],"K09_1": [-64.3307083, -23.2825639],"K09_2": [-64.3289694, -23.290125],"K29": [-64.3304083, -23.2981306],
"K49": [-64.3312306, -23.3077583],"K69": [-64.3330028, -23.3159389],"K10": [-64.3372167, -23.2870528],"K30_1": [-64.3383806, -23.2957917],
"K30_2": [-64.3390889, -23.2999194],"K50": [-64.3400083, -23.3067139],"K70": [-64.3426139, -23.31725],"K11": [-64.3461694, -23.2871667],
"K31": [-64.3476472, -23.2960194],"K51": [-64.3484583, -23.3049333],"K71": [-64.3495444, -23.3145333],"K91_1": [-64.3532167, -23.3198083],
"K91_2": [-64.3515, -23.3248694],"K12": [-64.3545556, -23.2862278],"K32": [-64.3555667, -23.2951],"K52": [-64.3570056, -23.3042139],
"K72_1": [-64.3593472, -23.3095583],"K72_2": [-64.3553611, -23.3122028],"K72_3": [-64.35965, -23.3121694],"K92_1": [-64.3588194, -23.3178611],
"K92_2": [-64.3595361, -23.3224028],"K93": [-64.3682275, -23.3174583],"K73": [-64.3677917, -23.31135],"K53": [-64.3651306, -23.3029639],
"K33": [-64.3644583, -23.2935861],"K13": [-64.3633583, -23.2850306],"K14": [-64.3741139, -23.2862944],"K34": [-64.3735694, -23.2935139],
"K54": [-64.3748, -23.3024722],"K15": [-64.3838575, -23.286525],"K35": [-64.3826361, -23.2930833],"K55": [-64.3838989, -23.302425],
"K16_1": [-64.3917194, -23.2834917],"K16_2": [-64.3893889, -23.2868222],"K16_3": [-64.3939, -23.2867611],"K36": [-64.3915778, -23.2936639],
"K56": [-64.3916167, -23.3025972],"K37_1": [-64.3967611, -23.2950444],"K37_2": [-64.4001583, -23.2947833],"K57": [-64.3998972, -23.3023056],
"K18": [-64.4104, -23.2825417],"K38": [-64.4180028, -23.2964611],"K58": [-64.4199806, -23.3030639],"H06": [-64.3777139, -23.22335],
"H07": [-64.3828222, -23.2303639],"H01": [-64.3891083, -23.2375861],"H02": [-64.3944333, -23.2444861],"H65": [-64.399175, -23.2509889],
"H66": [-64.4024167, -23.2562278],"H67": [-64.4068389, -23.2608972],"H61": [-64.4121722, -23.2637417],"H41": [-64.4175722, -23.259075],
"H42": [-64.4236333, -23.2609861],"H46": [-64.4288528, -23.2584722],"H45": [-64.4285528, -23.2523528],"H71": [-64.4150528, -23.255625],
"H69": [-64.4098361, -23.2491056],"H22": [-64.4031611, -23.239775],"H21": [-64.3964639, -23.2322417],"H09": [-64.3897583, -23.2233],"H29": [-64.3949444, -23.2124194],
"H30": [-64.4020333, -23.2206306],"H25": [-64.4059389, -23.2274583],"H26": [-64.4163389, -23.2349917],"H49": [-64.4163389, -23.2453917],"H50": [-64.4198333, -23.2453917],
"H51": [-64.4229778, -23.2512806],"Z79": [-64.391206,-23.125128],"E42": [-64.3315639, -23.1647361],"E41": [-64.3388722, -23.1609778],
"E45": [-64.3522528, -23.1607611],"E21": [-64.3386528, -23.1492444],"E46": [-64.3506472, -23.1548833],"E26": [-64.3492139, -23.149722],
"E25": [-64.3492139, -23.1492972],"E27": [-64.3478472, -23.1392444],"E49": [-64.3637472, -23.1550806],"E29": [-64.3617944, -23.1448889],
"E30": [-64.360025, -23.1370306],"E09": [-64.3582611, -23.1317972],"E05": [-64.3518972, -23.1332611],"E10": [-64.3577417, -23.1245639],
"E07": [-64.3480583, -23.1244361],"E06": [-64.3420194, -23.1281472],"E08": [-64.3391694, -23.1209083],"E01": [-64.3340389, -23.1219167],
"E70": [-64.3410861, -23.1058778],"E71": [-64.3328639, -23.099625],"E72": [-64.3211, -23.0922333],"E81_1": [-64.3211, -23.0940306],
"E81_2": [-64.3235472, -23.0877972],"E82_1": [-64.3126278, -23.0935833],"E82_2": [-64.3062722, -23.0964833],"E82_3": [-64.309, -23.0964833],
"E73_1": [-64.3246972, -23.1117722],"E73_2": [-64.3218972, -23.1087417],"E80_1": [-64.3220139, -23.1001025],"E80_2": [-64.3135639, -23.1001667],
"E74_1": [-64.3139639, -23.1083],"E74_2": [-64.3159056, -23.1141639],"E75_1": [-64.3092278, -23.1095833],"E75_2": [-64.3101611, -23.1148028],
"E75_3": [-64.3028833, -23.1053944],"E83_1": [-64.3010167, -23.0968056],"E83_2": [-64.2982806, -23.0924694],"E84_1": [-64.2991278, -23.0894861],
"E84_2": [-64.2960917, -23.0851056],"E85_1": [-64.2973667, -23.0788694],"E85_2": [-64.2981444, -23.0748528],"E85_3": [-64.2941972, -23.0713444],
"E87": [-64.2899417, -23.0803528],"E86": [-64.2899417, -23.0926111],"E79_1": [-64.2893639, -23.1082194],"E79_2": [-64.2870944, -23.1131889],
"E78": [-64.2791194, -23.0922361],"E95_1": [-64.3430472, -23.0828806],"E95_2": [-64.3369, -23.0796833],
"E98_1": [-64.3402528, -23.0706861],"E98_2": [-64.0404028, -23.0764],"E96_1": [-64.3485167, -23.0744778],"E96_2": [-64.3438917, -23.0775],
"E99_1": [-64.3498667, -23.0540389],"E99_2": [-64.3454444, -23.0610556],"E97_1": [-64.35565, -23.0586889],"E97_2": [-64.3518778, -23.0643361],
"Z51": [-64.349125, -23.1855306],"Z41": [-64.3530556, -23.1910917],"Z31": [-64.3589944, -23.1981972],"Z21": [-64.3651667, -23.2058944],
"Z11": [-64.3705167, -23.2144861],"Z01": [-64.3787639, -23.2153722],"Z12": [-64.3790444, -23.2084361],"Z22": [-64.3730333, -23.2006611],
"Z32": [-64.366775, -23.1932056],"Z42": [-64.3611778, -23.1854139],"Z52": [-64.3568111, -23.180375],"Z53": [-64.3671028, -23.1747583],
"Z43": [-64.3697056, -23.1799167],"Z33": [-64.3739611, -23.1881222],"Z23": [-64.3788028, -23.1972694],"Z13": [-64.3837944, -23.2046667],
"Z14": [-64.3895306, -23.201],"Z24": [-64.3836806, -23.1936222],"Z34": [-64.3811111, -23.1839556],"Z44": [-64.377275, -23.1752361],
"Z54": [-64.3760917, -23.1689333],"Z45": [-64.3824583, -23.1712083],"Z55": [-64.3855722, -23.1642111],"Z35": [-64.3908528, -23.1771417],
"Z25": [-64.3914528, -23.1898833],"Z15": [-64.3970806, -23.1969306],"Z16": [-64.4052111, -23.1919139],"Z26": [-64.398875, -23.1831444],
"Z36": [-64.3991778, -23.1682306],"Z46": [-64.3931944, -23.16045],"Z47": [-64.4017583, -23.1545667],"Z37": [-64.4074389, -23.162975],
"Z48": [-64.4107528, -23.1521556],"Z38": [-64.4162917, -23.1602778],"Z39": [-64.4233056, -23.153075],"Z60": [-64.4036417, -23.1462194],
"Z58": [-64.3953444, -23.1536278],"Z59": [-64.3927667, -23.1477472],"Z57": [-64.3826194, -23.1516611],"Z56": [-64.37355, -23.1541972],
"Z66": [-64.371525, -23.1427556],"Z67": [-64.3813028, -23.1407917],"Z77": [-64.3793611, -23.1340833],"Z76": [-64.3699528, -23.1352917],
"Z86": [-64.3702389, -23.1297167],"Z87": [-64.3653667, -23.1229],"Z79": [-64.390875, -23.1252889],"Z78": [-64.3796917, -23.1200583],
"G01": [-64.4041389, -23.2068167],"G02": [-64.4097611, -23.2142667],"G06": [-64.4113528, -23.199625],"G25": [-64.4147556, -23.2212639],
"G26": [-64.4207583, -23.2228008],"G21": [-64.4267556, -23.2366861],"G23": [-64.430825, -23.2416944],"G07": [-64.4181694, -23.2098583],
"G09": [-64.4231833, -23.2158667],"G10": [-64.4282611, -23.2236222],"G29": [-64.4321306, -23.2292972],"G38": [-64.4381167, -23.2282806],
"G39": [-64.4420944, -23.2257361],"G42": [-64.4352278, -23.2186972],"G41": [-64.4313889, -23.2116944],"G47": [-64.4290111, -23.2019528],
"G46": [-64.4250972, -23.19815],"G14": [-64.4106972, -23.1827306],"G15": [-64.4187556, -23.1781889],"G49": [-64.4262194, -23.1885222],
"G50": [-64.43065, -23.1938722],"G51": [-64.4341028, -23.198525],"G65": [-64.4355861, -23.2039611],"G66": [-64.4441972, -23.2076444],
"G67": [-64.4479139, -23.2116944],"G61": [-64.4509333, -23.2145194],"G40": [-64.4484139, -23.2207722],"G77": [-64.455025, -23.2129917],
"G71": [-64.4529417, -23.2081917],"G70": [-64.450825, -23.2036722],"G69": [-64.4481833, -23.1979556],"G81": [-64.4529083, -23.1968111],
"G74": [-64.4406167, -23.1902917],"G76": [-64.4463667, -23.1810222],"G73": [-64.4341917, -23.1835833],"G16": [-64.4278306, -23.1731472],
"G17": [-64.4355056, -23.1673528],"G75": [-64.4440889, -23.1743417],"G18": [-64.4440889, -23.1628917],"G19": [-64.4541917, -23.1620944],
"R91": [-64.2651194, -23.3286833],"R92": [-64.2691278, -23.3427222],"R93": [-64.2840222, -23.3441028],"R94": [-64.2848028, -23.3529944],
"R95": [-64.2858722, -23.3626028],"TU-DR01": [-64.2679306, -23.3573306],"R79": [-64.2705222, -23.3701944],"R78": [-64.2746222, -23.377825],
"R77": [-64.2785583, -23.3838861],"R76": [-64.2991972, -23.3884361],"R75": [-64.2879472, -23.3931556],"R74": [-64.2949583, -23.3992056],
"R73": [-64.3013861, -23.4062806],"R70": [-64.2862917, -23.4019917],"R71": [-64.2883944, -23.4057944],"R72": [-64.2931306, -23.4109472],
"R87": [-64.3821722, -23.4435306],"R86": [-64.3812944, -23.446225],"R85": [-64.3820528, -23.4490194],"R84": [-64.3824306, -23.4518278],
"R89": [-64.3575389, -23.4465944],"R88": [-64.3593611, -23.4491417],"R83": [-64.3615306, -23.454325],"R82": [-64.3417639, -23.4572694],
"R81": [-64.3238056, -23.4596944],"R1": [-64.3625556, -23.5032667],"R2": [-64.3665, -23.4987],"R3": [-64.3621528, -23.4940222],"R4": [-64.3607167, -23.4906639],
"R5": [-64.3603472, -23.4858083],"R11": [-64.3803417, -23.4974639],"R12": [-64.3786833, -23.4925611],"R13": [-64.376975, -23.4886417],
"R14": [-64.3760556, -23.4840694],"R21": [-64.3980944, -23.4951667],"R22": [-64.3946306, -23.4885444],"R33": [-64.4048472, -23.4813611],
"R23": [-64.3927694, -23.4830917],"R32": [-64.4066778, -23.4884667],"R31": [-64.40935, -23.4933222],"R43": [-64.41639, -23.4809139],
"R42": [-64.4186889, -23.48695],"R41": [-64.4208222, -23.4916],"R53": [-64.4263194, -23.4794833],"R52": [-64.4295222, -23.4851167],
"R51": [-64.4310444, -23.4917139],"R63": [-64.4375389, -23.4779972],"R62": [-64.439425, -23.4839583],"R61": [-64.4418667, -23.489475],
"R90": [-64.381875, -23.3536139],"R15": [-64.3893861, -23.4922389],"T03": [-64.4173361, -23.0667556],"T06": [-64.3934417, -23.0828278],
"T15": [-64.3943528, -23.094475],"T05": [-64.4107361, -23.0856528],"T14": [-64.4059417, -23.0996639],"T01": [-64.4095889, -23.0744611],"T02": [-64.4168778, -23.0779889],"T04": [-64.4265167, -23.0728139],"T11": [-64.4363472, -23.0791306],"T10": [-64.4300167, -23.0873278],"T12": [-64.4255528, -23.0984611],"T07": [-64.3781167, -23.0853611],"T13": [-64.4219944, -23.1075944],"I78": [-64.4469278, -23.1280583],"I79": [-64.4539944, -23.1236694],"I77": [-64.4346667, -23.1191917],"I76": [-64.4394417, -23.1150444],"I75": [-64.4429111, -23.1104583],"I74": [-64.4451861, -23.1044694],"I73": [-64.4464944, -23.0988472],"I72": [-64.4489861, -23.0938083],"I71": [-64.4511, -23.08895],"I70": [-64.4417667, -23.0709083],"I61": [-64.3573722, -23.0735861],"I62": [-64.3668806, -23.0707389],"I65": [-64.3617167, -23.0335722],"I64": [-64.3617167, -23.0335722],"I63": [-64.3709583, -23.0356528],"I68_1": [-64.37575, -23.0340361],"I68_2": [-64.3819528, -23.0335139],"I60": [-64.3633417, -23.0805472],"I34": [-64.3750778, -23.0720917],"I32_1": [-64.3697028, -23.0683667],"I32_2": [-64.3840722, -23.0683083],"I32_3": [-64.3922389, -23.0674694],"I33": [-64.3940667, -23.0700472],"I25_1": [-64.3742444, -23.0628722],"I25_2": [-64.3814944, -23.0650833],"I18": [-64.4050806, -23.0653806],"I17": [-64.3957139, -23.0630056],"I23_1": [-64.378225, -23.0556639],"I23_2": [-64.3842167, -23.0503222],"I24_1": [-64.3913556, -23.0536083],"I24_2": [-64.3869694, -23.0596278],"I15": [-64.4004139, -23.057],"I14_1": [-64.4080917, -23.0616722],"I14_2": [-64.4138944, -23.0612],"I22": [-64.3831694, -23.0471944],"I20_1": [-64.3857472, -23.0426306],"I20_2": [-64.3893028, -23.038425],"I21_1": [-64.3942833, -23.0480694],"I21_2": [-64.3973889, -23.0431056],"I13_1": [-64.4018194, -23.0510222],"I13_2": [-64.4032528, -23.0461889],"I28_1": [-64.4073389, -23.0499472],"I28_2": [-64.4113139, -23.0512861],"I30_1": [-64.4141972, -23.0553889],"I30_2": [-64.4194306, -23.0552167],"I27": [-64.4040889, -23.0381556],"I26": [-64.4120389, -23.0436417],"I29_1": [-64.4220139, -23.0417417],"I29_2": [-64.4208639, -23.0479778],"I02": [-64.4141, -23.0383972],"I01_1": [-64.4140389, -23.0325278],"I01_2": [-64.4221639, -23.0354028],"I05": [-64.4039, -23.0285139],"I81": [-64.4283306, -23.0453361],"I82": [-64.4354694, -23.0443361],"I83": [-64.438028, -23.0291667],"I84": [-64.4339444, -23.0298722],"I85": [-64.4282222, -23.0115667],"I86": [-64.4332194, -23.013025],"I87": [-64.4222083, -22.9916028],"I88": [-64.4289972, -22.9917028],"I69": [-64.3716833, -23.0222194],"J43_1": [-64.4199472, -23.0288167],"J43_2": [-64.4148361, -23.0274528],"J41": [-64.4110167, -23.0238583],"J42_1": [-64.4059806, -23.0224111],"J42_2": [-64.4070139, -23.0151833],"J40": [-64.4141833, -23.0178861],"J44": [-64.4219694, -23.0174306],"J31": [-64.4156278, -23.0117556],"J30": [-64.4121917, -23.0058111],"J32_1": [-64.4219667, -23.0058722],"J32_2": [-64.4182639, -22.9998056],"J28": [-64.4124056, -22.9975944],"J57": [-64.3920722, -23.0182889],"J58": [-64.3941972, -23.0140250],"J56": [-64.3923611, -23.0093472],"J59_1": [-64.3986000, -23.0100722],"J59_2": [-64.3971556, -23.0083444],"J21_1": [-64.4001972, -23.0037111],"J21_2": [-64.3928972, -23.0040778],"J20": [-64.4043472, -22.9967556],"J55": [-64.3828333, -23.0063111],"J52": [-64.3734472, -23.0149167],"J54": [-64.3778222, -23.0041972],"J53": [-64.3698750, -23.0038472],"J22": [-64.3989333, -22.9989311],"J15": [-64.3987889, -22.9878944],"J16": [-64.3915417, -22.9876278],"J14": [-64.4045722, -23.23276111],"J09_1": [-64.3991389, -22.9819722],"J09_2": [-64.4076806, -22.9813861],"J10_1": [-64.3990333, -22.9757417],"J10_2": [-64.4079306, -22.9757361],"J13": [-64.4005000, -22.9695972],"J12_1": [-64.4109222, -22.9689833],"J12_2": [-64.4167222, -22.9698750],"J01": [-64.4208667, -22.9670500],"J05": [-64.4102583, -22.9636639],"J03": [-64.4106556, -22.9585333],"J02": [-64.4171278, -22.9630000],
}
COORDENADAS_LOTES_REVERSO = {tuple(v): k for k, v in COORDENADAS_LOTES.items()}

# =============================================================================
# 2. FUNCIONES AUXILIARES (DEBE TENER SANGRÍA INTERNA)
# =============================================================================

def haversine(coord1, coord2):
    lon1, lat1 = coord1
    lon2, lat2 = coord2
    R = 6371000
    lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])
    dlon = lon2 - lon1
    dlat = lat2 - lat1
    a = sin(dlat / 2)**2 + cos(lat1) * cos(lat2) * sin(dlon / 2)**2
    c = 2 * atan2(sqrt(a), sqrt(1 - a))
    distance = R * c
    return distance

def find_best_grouping_variable(all_lotes, min_group_size=1):
    min_total_internal_distance = float('inf')
    best_group_a = None
    best_group_b = None
    all_lotes_set = set(all_lotes)
    N = len(all_lotes)
    for size_a in range(min_group_size, N - min_group_size + 1):
        for group_a_tuple in combinations(all_lotes, size_a):
            group_a = list(group_a_tuple)
            group_b = list(all_lotes_set - set(group_a))
            
            # Función anidada para calcular distancia interna (indenta correctamente)
            def calculate_internal_distance(group):
                dist = 0
                L = len(group)
                if L < 2:
                    return 0
                for i in range(L):
                    for j in range(i + 1, L):
                        lote1 = group[i]
                        lote2 = group[j]
                        coord1 = COORDENADAS_LOTES[lote1]
                        coord2 = COORDENADAS_LOTES[lote2]
                        dist += haversine(coord1, coord2)
                return dist
                
            dist_a = calculate_internal_distance(group_a)
            dist_b = calculate_internal_distance(group_b)
            current_total_distance = dist_a + dist_b
            if current_total_distance < min_total_internal_distance:
                min_total_internal_distance = current_total_distance
                best_group_a = group_a
                best_group_b = group_b
    return best_group_a, best_group_b, round(min_total_internal_distance / 1000, 2)

def make_api_request(points_list):
    URL_ROUTE_FINAL = f"https://graphhopper.com/api/1/route?key={API_KEY}"
    request_body = {
        "points": points_list,
        "vehicle": "car",
        "locale": "es",
        "instructions": False,
        "points_encoded": False,
        "optimize": "true"
    }
    try:
        response = requests.post(URL_ROUTE_FINAL, headers=HEADERS, data=json.dumps(request_body))
        response.raise_for_status()
        return response.json()
    except requests.exceptions.HTTPError as e:
        return None
    except requests.exceptions.RequestException as e:
        return None
    except KeyError as e:
        return None

def generate_geojson(route_name, points_sequence, path_coordinates, total_distance_km, vehicle_id):
    features = []
    num_points = len(points_sequence)
    color_map = {"AF820AB": "#0080FF", "AE898TW": "#FF4500"}
    line_color = color_map.get(vehicle_id, "#000000")
    for i in range(num_points):
        coords = points_sequence[i]
        is_origin = (i == 0)
        is_destination = (i == num_points - 1)
        lote_name = "Ingenio"
        if not is_origin and not is_destination:
            lote_name = next((name for original_coords, name in COORDENADAS_LOTES_REVERSO.items()
                             if round(original_coords[0], 6) == round(coords[0], 6) and round(original_coords[1], 6) == round(coords[1], 6)),
                             "Punto Intermedio")
        point_type = "PARADA INTERMEDIA"
        color = line_color
        symbol = str(i)
        if is_origin:
            point_type = "ORIGEN (Ingenio)"
            color = "#008000"
            symbol = "star"
        elif is_destination:
            point_type = "DESTINO FINAL (Regreso al Ingenio)"
            color = "#FF0000"
            symbol = "square"
        features.append({
            "type": "Feature",
            "geometry": {"type": "Point", "coordinates": coords},
            "properties": {
                "name": f"{i} - {point_type} ({lote_name})",
                "marker-color": color,
                "marker-symbol": symbol,
                "order": i,
                "vehicle": vehicle_id
            }
        })
    features.append({
        "type": "Feature",
        "geometry": {"type": "LineString", "coordinates": path_coordinates},
        "properties": {
            "name": f"Ruta Completa: {route_name}",
            "stroke": line_color,
            "stroke-width": 4,
            "distance_km": total_distance_km,
            "vehicle": vehicle_id
        }
    })
    return {"type": "FeatureCollection", "features": features}

def generate_geojson_io_link(geojson_object):
    geojson_string = json.dumps(geojson_object, separators=(',', ':'))
    encoded_geojson = quote(geojson_string)
    base_url = "https://geojson.io/#data=data:application/json,"
    return base_url + encoded_geojson

# =============================================================================
# 3. FUNCIÓN PRINCIPAL EXPORTABLE (solve_route_optimization)
# =============================================================================

def solve_route_optimization(all_intermediate_stops):
    group_a_names, group_b_names, min_internal_dist = find_best_grouping_variable(all_intermediate_stops)
    if not group_a_names or not group_b_names:
        return {"error": "No se pudo realizar la agrupación de lotes."}
    VEHICLE_A_ID = "AF820AB"
    VEHICLE_B_ID = "AE898TW"
    results = {"agrupacion_distancia_km": min_internal_dist}

    # --- RUTA A (AF820AB) ---
    all_stops_coords_A = [COORDENADAS_ORIGEN] + [COORDENADAS_LOTES[name] for name in group_a_names] + [COORDENADAS_ORIGEN]
    response_A = make_api_request(all_stops_coords_A)
    if response_A:
        TOTAL_DISTANCE_KM_A = round(response_A['paths'][0]['distance'] / 1000, 2)
        optimized_indices_A = response_A['paths'][0]['points_order']
        all_stops_names_A = ["Ingenio"] + group_a_names + ["Ingenio"]
        optimized_name_sequence_A = [all_stops_names_A[i] for i in optimized_indices_A]
        results["ruta_a"] = {
            "patente": VEHICLE_A_ID,
            "nombre": VEHICLES[VEHICLE_A_ID]['name'],
            "lotes_asignados": group_a_names,
            "distancia_km": TOTAL_DISTANCE_KM_A,
            "orden_optimo": optimized_name_sequence_A[1:-1],
            "geojson_link": generate_geojson_io_link(generate_geojson("Ruta A", [all_stops_coords_A[i] for i in optimized_indices_A], response_A['paths'][0]['points']['coordinates'], TOTAL_DISTANCE_KM_A, VEHICLE_A_ID))
        }
    else:
        return {"error": "Fallo al obtener la Ruta A de la API. (Verifique API Key o límites)"}

    # RETARDO PARA EVITAR LÍMITE DE API
    time.sleep(75)

    # --- RUTA B (AE898TW) ---
    all_stops_coords_B = [COORDENADAS_ORIGEN] + [COORDENADAS_LOTES[name] for name in group_b_names] + [COORDENADAS_ORIGEN]
    response_B = make_api_request(all_stops_coords_B)
    if response_B:
        TOTAL_DISTANCE_KM_B = round(response_B['paths'][0]['distance'] / 1000, 2)
        optimized_indices_B = response_B['paths'][0]['points_order']
        all_stops_names_B = ["Ingenio"] + group_b_names + ["Ingenio"]
        optimized_name_sequence_B = [all_stops_names_B[i] for i in optimized_indices_B]
        results["ruta_b"] = {
            "patente": VEHICLE_B_ID,
            "nombre": VEHICLES[VEHICLE_B_ID]['name'],
            "lotes_asignados": group_b_names,
            "distancia_km": TOTAL_DISTANCE_KM_B,
            "orden_optimo": optimized_name_sequence_B[1:-1],
            "geojson_link": generate_geojson_io_link(generate_geojson("Ruta B", [all_stops_coords_B[i] for i in optimized_indices_B], response_B['paths'][0]['points']['coordinates'], TOTAL_DISTANCE_KM_B, VEHICLE_B_ID))
        }
    else:
        return {"error": "Fallo al obtener la Ruta B de la API. (Verifique API Key o límites)"}

    return results
